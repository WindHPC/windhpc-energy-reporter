#!/bin/bash
#
# Copyright (c) 2025       Helmut-Schmidt-Universität/
#                          Universität der Bundeswehr Hamburg.  All rights reserved.
#

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PARENT_DIR="$( dirname "$SCRIPT_DIR" )"
VENV_DIR="$PARENT_DIR/.venv"
REQ_FILE="$PARENT_DIR/requirements.txt"
ENV_FILE="$PARENT_DIR/.env"

# Create virtual environment if it doesn't exist
if [ ! -d "$VENV_DIR" ]; then
    echo "Creating virtual environment at $VENV_DIR"
    python3 -m venv "$VENV_DIR" || { echo "Failed to create virtualenv"; return 1; }
fi

# Activate the virtual environment
# Use `return` instead of `exit` because this is meant to be sourced
if [ -f "$VENV_DIR/bin/activate" ]; then
    echo "Activating virtual environment..."
    export VIRTUAL_ENV_DISABLE_PROMPT=1
    source "$VENV_DIR/bin/activate"
    export PS1="(.venv) \w \$ "
else
    echo "Activation script not found!"
    return 1
fi

# Install requirements if file exists
if [ -f "$REQ_FILE" ]; then
    echo "Installing requirements from $REQ_FILE"
    pip install --upgrade pip --quiet
    pip install -r "$REQ_FILE" --quiet
else
    echo "No requirements.txt found at $REQ_FILE"
fi

echo "Creating $ENV_FILE"
TUTORIAL=$(tutorial --paged)
{
    echo "WINDHPC_SYSTEM=HSU"
    # Parse InfluxDB values from `tutorial` and write to .env
    echo "$TUTORIAL" | awk '
        /InfluxDB URL:/ {
            sub(/InfluxDB URL: /, "", $0)
            url = $0
        }
        END {
            print "INFLUX_URL=" url
        }
    '
    echo "$TUTORIAL" | awk '
        /InfluxDB token:/    { getline; gsub(/"/, "", $0); token=$0 }
        END {
            print "INFLUX_TOKEN=" token
        }
    '
} > "$ENV_FILE"
